digraph EpicRunner {
    label="Process all tasks in an epic"
    goal="Implement all child tasks of epic attractor-qsb: Codebase Simplification Refactor. Attractor has ~2,575 lines of dead LLM provider code that compiles but never executes, plus three oversized modules (handlers/mod.rs 1,232L, cli/main.rs 1,046L, agent/lib.rs 1,004L) that mix unrelated concerns. This epic covers feature-gating the dead code and splitting the oversized modules into focused files. Pure structural cleanup â€” no behavioral changes, no API changes, no new features. Motivation: the pipeline shells out to CLI tools via CodergenHandler, making the attractor-llm HTTP adapters dead code from an earlier architecture. Giant modules slow onboarding, increase merge conflict risk, and build times include compiling reqwest+streaming deps for code that never runs."
    model="sonnet"

    start [shape="Mdiamond"]
    done  [shape="Msquare"]

    // --- Pick the next task ---
    pick_task [
        shape="diamond"
        label="Pick Next Task"
        node_type="conditional"
        llm_model="haiku"
        allowed_tools="Bash(bd:*)"
        prompt="Run: bd show attractor-qsb
Look at the BLOCKS section to see child tasks.

Then run: bd ready
Find the first ready (unblocked, open) child task of epic attractor-qsb.

If you find one:
- Run: bd update <task-id> --status=in_progress
- Write the task ID and full description to .attractor/current_task.md
- Respond with MORE on the last line

If all child tasks are closed (no more ready tasks for this epic):
- Respond with DONE on the last line"
    ]

    // --- Investigate ---
    investigate [
        shape="box"
        label="Investigate"
        allowed_tools="Read,Grep,Glob,Bash(bd:*)"
        prompt="Read .attractor/current_task.md to get the current task ID and description.
Run bd show <task-id> to get full details.

Investigate the codebase to understand what needs to change:
- Find the relevant files and functions
- Understand the current behavior
- Identify what needs to change

Write your findings to .attractor/investigation.md including:
- Files to modify
- Current behavior
- Required changes
- Any risks or dependencies"
    ]

    // --- Implement ---
    implement [
        shape="box"
        label="Implement"
        prompt="Read .attractor/current_task.md for the task and .attractor/investigation.md for the plan.
Implement the changes described. Follow existing code patterns and conventions.
Keep changes minimal and focused on the task requirements."
    ]

    // --- Test ---
    run_tests [
        shape="box"
        label="Run Tests"
        prompt="Read .attractor/current_task.md to understand what was changed.
Run the relevant test suite for the modified code.
If tests fail, fix the issues and re-run until green.
Write the test results to .attractor/test-results.md"
    ]

    // --- Verify ---
    verify [
        shape="diamond"
        label="Verify"
        node_type="conditional"
        prompt="Read .attractor/current_task.md for the task requirements.
Check the changes:
1. Review the git diff
2. Run the linter on changed files
3. Verify tests pass (read .attractor/test-results.md)
4. Check that the task's acceptance criteria are met

If everything looks good, respond with PASS on the last line.
If there are problems, respond with FAIL on the last line."
    ]

    fixup [
        shape="box"
        label="Fix Issues"
        prompt="Read .attractor/current_task.md and .attractor/investigation.md for context.
The verification step found problems. Fix any failing tests, lint errors, or unmet acceptance criteria.
Re-run tests after fixing."
    ]

    // --- Close this task ---
    close_task [
        shape="box"
        label="Close Task"
        allowed_tools="Bash(bd:*),Bash(git:*)"
        prompt="Read .attractor/current_task.md to get the task ID.
1. Stage changes: git add -A
2. Commit with a descriptive message referencing the task ID
3. Close the task: bd close <task-id> --reason='Implemented successfully'
4. Run: bd sync --flush-only"
    ]

    // --- Check if more tasks remain ---
    check_remaining [
        shape="diamond"
        label="More Tasks?"
        node_type="conditional"
        llm_model="haiku"
        allowed_tools="Bash(bd:*)"
        prompt="Run: bd show attractor-qsb
Look at the BLOCKS section. Count how many child tasks are still open.

Run: bd ready
Check if any remaining child tasks of this epic are ready (unblocked, open).

If there are more ready tasks, respond with MORE on the last line.
If all tasks are closed or remaining tasks are blocked, respond with DONE on the last line."
    ]

    // --- Edges ---
    start -> pick_task

    pick_task -> investigate [label="MORE", condition="preferred_label=MORE"]
    pick_task -> done        [label="DONE", condition="preferred_label=DONE"]

    investigate -> implement -> run_tests -> verify

    verify -> close_task [label="PASS", condition="preferred_label=PASS"]
    verify -> fixup      [label="FAIL", condition="preferred_label=FAIL"]
    fixup  -> verify

    close_task -> check_remaining

    check_remaining -> pick_task [label="MORE", condition="preferred_label=MORE", loop_restart=true]
    check_remaining -> done      [label="DONE", condition="preferred_label=DONE"]
}
